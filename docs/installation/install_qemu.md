# Установка системы в Qemu/KVM (алтернативный вариант установки системы, но не на реальное железо, а в виртуальную машину)

Вы можете захотеть установить Calmira не на реальное железо, а в виртуальную машину Qemu/KWM. Создайте виртуальную машину со следующими параметрами:

* **Тип ОС:** Generic Linux/Generic Default;
* **Процессор:** qemu64/kvm64/копирующий конфигурацию ЦП хоста (в случае если на хосте процессор x86_64);
* **Оперативная память:** 64 Мб;
* **Жёсткий диск:** `qcow2` 1.5 Гб;
* **Шина диска:** SATA.

Всё это создавалось в virt-manager. Параметры рекомендуемые.

Теперь нужно скопировать распакованный в [этой](unpack.md) инструкции дистрибутив в только что созданный образ жёсткого диска (образ сгенерировался во время создания виртуальной машины). Нужно смонтировать этот образ. Для этого подключите модуль `qemu-nbd` и смонтируйте образ ЖД:

```bash
# Подключение модуля ядра:
sudo modprobe nbd max_part=8

# Подключение образа:
sudo qemu-nbd --connect=/dev/nbd0 /var/lib/libvirt/images/$NAME.qcow2

sudo fdisk /dev/nbd0 -l
mkdir /mnt/calmira_system
```

Замените `$NAME` на имя виртуальной машины (и, по совместительству, имя диска).

## Разметка разделов

Необходимо разметить новый "жёсткий диск". Для этого выполните:

```bash
sudo cfdisk /dev/nbd0
```

`cfdisk` запросит у вас, какую таблицу разделов выбрать. Выбирайте `mbr` (она же `dos`), либо новомодную `gpt`. В данном случае нет никакой разницы в выборе. Советуется выбрать `mbr` (`dos`).

Если вы всё-таки выбрали `gpt`, то создайте в начале диска раздел объёмом 1 Мб без файловой системы. Тип: `BIOS Boot`.

Потом (и для `gpt`, и для `mbr`) создайте корневой раздел. Он должен занимать всё оставшееся место. Тип: `Linux filesystem`. При желании можете создать ещё и раздел со `swap`. Его объём должен равняться половине от объёма оперативной памяти (к примеру, в виртуальной машине установлено значение ОЗУ, равное 64 Мб. Для подкачки тогда нужно выбрать объём 32 Мб). Тип раздела с подкачкой: `Linux swap`.

## Форматирование разделов

После разметки отформатируйте нужные разделы. Для форматирования корневого раздела выполните:

```bash
sudo mkfs.ext4 /dev/nbd0pX
```

Замените `nbd0pX` на нужную метку раздела. Обычно это `nbd0p1`, если таблица разделов `mbr` (`dos`), или `nbd0p2`, если таблица разделов - `gpt`.

Для форматирования подкачки (если вы её создали):

```bash
mkswap /dev/nbd0pX
```

Замените `nbd0pX` на нужную метку раздела. Обычно это `nbd0p2`, если таблица разделов `mbr` (`dos`), или `nbd0p3`, если таблица разделов - `gpt`.

## Копирование системы

Смонтируйте корневой раздел:

```bash
sudo mount /dev/nbd0pX /mnt/calmira_system
```

Замените `nbd0pX` на нужную метку корневого раздела. Обычно это `nbd0p1`, если таблица разделов `mbr` (`dos`), или `nbd0p2`, если таблица разделов - `gpt`.

После того, как смонтировали раздел, скопируйте на него данные из распакованного образа дистрибутива. Во-первых убедитесь, что находитесь в директории `squashfs-root`:

```bash
pwd
```

Если всё верно, приступайте к копированию:

```bash
sudo cp -rvxa * /mnt/calmira_system/
```

Во время копирования на экран будут выведены скопированные файлы. Внимательно прочитайте вывод: в нём не должно содержаться `error`, `fail` и пр. Если вы не хотите видеть подробный результат о каждом скопированном файле, то уберите ключ `-v` из команды. В таком случае на экран будут выведены сообщения об ошибках и предупреждения (если они есть).

## Завершение установки

Вы настраивали систему в среде `chroot`. После того, как настройку системы вы завершили, выйдите из chroot командой:

```bash
logout

sudo umount /mnt/calmira_system/dev{/pts,}
sudo umount /mnt/calmira_system/{sys,proc,run}
```

И отмонтируйте образ жёсткого диска для Qemu:

```bash
sudo umount /mnt/calmira_system
sudo qemu-nbd --disconnect /dev/nbd0
sudo rmmod nbd
```

Установка завершена!

***

[Назад - Установка системы на ПК](install_sys.md)
