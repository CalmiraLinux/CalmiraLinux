# Создание бинарного пакета для cpkg

За время использования ОС вы можете захотеть сделать бинарный пакет для cpkg с какой-либо программой для её удобной установки. В данной статье рассказано, как сделать это. Несмотря на то, что основной упор в Calmira делается на сборку ПО из исходного кода, разработчики не препятствуют установке готовых бинарных пакетов, хотя их официально не предоставляют.

## Введение

Пакет для `cpkg` представляет собой tar архив, сжатый методом `xz`. В архиве находится директория PKG, в которой находятся файлы `config.sh`, `preinst.sh`/`reremove.sh` (опционально), `postinst.sh`/`postremove.sh` (опционально), а так же директория `pkg`, в которой находится сам пакет. Дерево каталогов пакета должно совпадать с деревом каталогов операционной системы.

**Назначение файлов и директорий:**
* `PKG` - в этой директории находятся сам пакет и файлы описания, а так же файлы пред- и послеустановочных настроек.
* `PKG/pkg` - директория с пакетом
* `PKG/config.sh` - описание пакета
* `PKG/preinst.sh` - скрипт, выполняющийся до установки пакета. Может быть полезен для настройки системы или окружения перед установкой пакета. Наличие этого файла **опционально**.
* `PKG/postinst.sh` - скрипт, выполняющийся после установки пакета. Может быть полезен для настройки пакета. Наличие этого файла **опционально**.
* `PKG/preremove.sh` - скрипт, выполняющийся до удаления пакета. Может быть полезен для настройки системы или окружения.
* `PKG/postremove.sh` - скрипт, выполняющийся после удаления пакета. Может быть полезен для окончательной настройки системы/окружения, а так же удаления некоторых конфигурационных (и других) файлов, не вошедших в список файлов пакета.
* `PKG/metadata.xz` - в данном архиве содержится информация о совместимости пакета с дистрибутивом Calmira.

Тогда дерево каталогов пакета будет примерно таким:
```
|--- some_package.txz
    |--- PKG
        |--- config.sh
        |--- {post,pre}inst.sh
        |--- {post,pre}remove.sh
        |--- metadata.xz
        |--- pkg
            |--- usr
            |--- etc
            |--- var
            |--- ...
```

В случае, если это пакет с исходным кодом (port-пакет), в директории `PKG` наличие файла `port.sh` **обязательно**. В нём описываются инструкции по сборке и установке пакета.

Наличие шебанга обязательно:
```bash
#!/bin/bash
```

Пример:
```bash
#!/bin/bash

cd /var/cache/cpkg/archives	# Переход в рабочую директорию
wget https://www.some.site/some_package.tar.gz	# Скачивание пакета some_package.tar.gz с сайта https://www.some.site
tar -xvf some_package.tar.gz	# Распаковка пакета с исходным кодом

cd some_package
./configure --prefix=/usr \
	--bindir=/usr/bin \
	--sysconfdir=/etc	# Конфигурирование пакета
make		# Сборка
make install	# Установка
```

> **ВНИМАНИЕ**! Мы НАСТОЯТЕЛЬНО НЕ рекомендуем использовать port-пакеты. Если хотите автоматизировать сборку ПО из исходного кода, то используйте [систему портов Calmira GNU/Linux](intro_ports.md).

### Строение файла `config.sh`

В этом файле описывается сам пакет. В нём указывается имя пакета, версия, мейнтейнер, описание и файлы пакета.
Пример такого файла:
```bash
NAME=some
VERSION=1.0
MAINTAINER="Linuxoid85 <linuxoid85@gmail.com>"
REQ_DEPS="bash"
RECOM_DEPS="openssl freetype"
OPT_DEPS="coreutils"
TEST_DEPS="expect"
BEF_DEPS="cpkg"
CON_DEPS="wget make-ca"
PRIORITY=user
DESCRIPTION="Some package for test cpkg package manager"
FILES="/usr/bin/{some_pkg,test_cpkg} /usr/share/some_pkg/"
```

**Описание переменных:**
* `NAME` - имя пакета;
* `VERSION` - версия пакета/программы;
* `MAINTAINER` - сборщик (сопровождающий) пакета;
* `REQ_DEPS` - необходимые для работы пакета зависимости;
* `RECOM_DEPS` - рекомендуемые зависимости;
* `OPT_DEPS` - опциональные зависимости;
* `TEST_DEPS` - необходимые для тестирования пакета зависимости (указывать только в port-пакетах);
* `BEF_DEPS` - какие пакеты требуют, чтобы указанный пакет был собран и установлен до их сборки и установки;
* `CON_DEPS` - зависимости, с которыми конфликтует данный пакет;
* `PRIORITY` - приоритет пакета;
* `DESCRIPTION` - описание пакета;
* `SITE` - сайт пакета, либо ссылка, откуда можно скачать оригинал/архив с исходным кодом, из которого собирался пакет;
* `FILES` - все файлы пакета.

Если в одной директории (чаще всего это `/bin`, `/usr/bin`, `/etc` и пр.) несколько файлов из пакета, то нет смысла дублировать пути до этих файлов. Проще объединить их в массив. К примеру, есть директория `/usr/bin`, в которую устанавливаются файлы `some_pkg` и `test_cpkg`. В строке `FILES="..."` они объединены в массив `/usr/bin/{some_pkg,test_cpkg}`. То есть, файлы перечисляются в фигурных скобках {}.

Так же, все отдельные файлы разделяются между собой пробелами.

В версии cpkg 1.0pa4 была добавлена функция просмотра зависимостей пакета (при установке, удалении и просмотра информации о пакете).

Типов зависимостей несколько:

| Наименование | Объяснение | В какой строке отображается при установке или удалении исходного пакета |
|--------------|------------|-------------------------------------------------------------------------|
| `REQ_DEPS`   | необходимые зависимости. Если вы устанавливаете бинарный пакет, то необходимые зависимости можно установить после, но если вы ставите port-пакет, то поставьте сначала необходимые зависимости, а только потом пакет. | `Необходимые:` |
| `RECOM_DEPS` | рекомендуемые зависимости. Советуется устанавливать их | `Рекомендуемые:` |
| `OPT_DEPS` | опциональные зависимости. Устанавливать их не обязательно, они лишь служат для добавления определённого функционала. Если вы ставите бинарный пакет, то не важен порядок действий: вы можете установить их как до установки исходного пакета, так и после, если этих зависимостей нет в пункте `BEF_DEPS`. Но в случае port-пакета всё намного строже - опциональные пакеты должны быть установлены ДО установки исходного пакета. | `Опциональные:` |
| `TEST_DEPS` | зависимости, необходимые для тестирования пакета (распространяется только на port-пакеты). Эти зависимости должны быть установлены ДО установки исходного пакета. | `Для тестирования:` |
| `CON_DEPS` | зависимости, которые конфликтуют с данным пакетом. Их желательно удалить. | `Конфликтует с:` |
| `BEF_DEPS` | необязательные зависимости, определяющие, что указанный пакет должен быть собран ДО установки/сборки тех зависимостей. Применимо к port-пакетам. | `Установлен перед ними:` |

Помимо этого, есть приоритет пакета - `PRIORITY`. Только два значения: `system`, если пакет системный и `user` - если пользовательский. Т.е., в первую группу входят все пакеты, которые обеспечивают корректную работу МИНИМАЛЬНОЙ системы. Системные пакеты удалить нельзя. Их можно лишь обновлять до новой версии и просматривать информацию о них. А с пользовательскими пакетами (приоритет `user`) можно делать всё, что угодно.

> Настоятельно рекомендуем использовать пользовательский (`user`) пакета! Все системные пакеты собираются одним мейнтейнером для поддержания работоспособности системы. Как правило, большинство пакетов от сторонних сборщиком с приоритетом `system` не только не являются системными, но и при удалении этих пакетов в системе не произойдёт ничего.

## Сборка пакета

Создайте некую директорию `/usr/PKG/pkg`, в которую, впоследствии, будет установлен пакет. И выполните процедуру сборки. Но тут загвоздка. Использовать альтернативный префикс `/usr/PKG/pkg` в процессе конфигурирования (напр., `configure`) сделает пакет нерабочим. Будут сделаны неправильные ссылки, файлы будут скопированы не в те директории. В каталоге `/usr/PKG/pkg` нужно создать зеркальную копию `/usr`, либо же корня (`/`) - в случае, если пакет системный. Поэтому при конфигурировании пакета (напр., создании Makefile) используйте префикс `/usr` или `/` (по умолчанию). А потом с помощью `make DESTDIR=/usr/PKG/pkg install` сфальсифицировать установку пакета в корень, либо же в указанные директории (когда как на самом деле пакет будет установлен в `/usr/PKG/pkg`).

В Calmira GNU/Linux LX4 1.1 используется стандартная структура директорий, где `/bin`, `/sbin`, `/usr/bin` и `/usr/sbin` - разные каталоги. Поэтому если бинарные файлы должны быть установлены в `/bin`, бинарные файлы для суперползователя в `/sbin`, и пр. При необходимости (если некоторые файлы пакета должны быть установлены в `/bin`, `/sbin`, `/lib`) используйте ключи `--bindir=/bin`, `--sbindir=/sbin`, `--libexecdir=/lib`.

Выполните процедуру конфигурирования:

```bash
./configure --prefix=$PREFIX \
            --bindir=$BINDIR \
            --sbindir=$SBINDIR
```

Если вы используете систему сборки `meson`, то замените процедуру конфигурирования на корректную для этой ситсемы сборки.

Используйте нужные вам ключи. В любом случае, процедура конфигурирования должна быть точно такой, какой она является по умолчанию.

Если конфигурирование прошло успешно, выполните сборку:

```bash
make
```

Если используете `meson`, то сборка будет такой:

```bash
ninja
```

После чего установите пакет, только не в те директории, что были указаны `configure`/`meson`, а в `/usr/PKG/pkg`:

```bash
make DESTDIR=/usr/PKG/pkg install
```

Вместо `DESTDIR` могут быть переменные `INSTALL_DIR`, `prefix` и пр. Или может не быть вообще, тогда файлы придётся находить и копировать вручную. О подробной информации смотрите в документации к установке пакета.

Теперь создайте файл `config.sh` в директории `/usr/PKG` и запишите в него информацию о пакете:

* Название пакета;
* Версия пакета;
* Описание пакета;
* Сборщик пакета;
* Зависимости пакета;
* Файлы пакета

И прочую информацию. Запишите её в соответствии с пунктом "Введение".

Для того, чтобы записать список файлов в раздел `FILE`, перейдите в директорию `pkg` и выведите список файлов:

```bash
cd pkg

find
```

Запишите вывод в раздел `FILE`:

```bash
FILE="./usr/bin/file
....
....
"
```

Удалите из вывода все точки в начале, а так же все файлы, относящиеся к другим пакетам. Так же удалите все `/bin`, `/usr/bin`, `/usr/share` и пр. Оставьте только файлы. Одна ошибка - и при удалении пакета можно сломать либо какой-то отдельный пакет, либо всю систему.

Если у пакета есть `preinstall` и `postinstall` скрипты, то создайте их. Назовите `preinst.sh` и `postinst.sh` соотв.

И соберите пакет:

```bash
# Переход из /usr/PKG на уровень ниже (в /usr):
cd ..

# Сборка пакета
tar -cf PKG $PACKAGE_NAME.txz -J
```

Замените `$PACKAGE_NAME` на имя. Оно должно включать в себя имя и версию пакета, например: `some_1.0.txz`.
