# makesystem.sh

Скрипт для автоматизированной сборки системы. На данный момент применяется для сборки ночных версий Calmira, однако скоро будет использоваться и для установки небинарных (src-base) редакций Calmira.

## Файлы

- `./makesystem.py` - исходный скрипт;
- `/etc/makesystem.json` - настройки скрипта. В этом файле содержится список всех нужных скриптов для сборки, а так же порядок сборки.

## Настройка

В файле `/etc/makesystem.json` содержатся настройки скрипта.

- Блок `files` содержит список всех необходимых файлов;
- Блок `packages` - все пакеты (в нужном порядке), которые необходимо собрать в базовой системе;
- Блок `systemd-packages` - все пакеты (в нужном порядке), которые нужно собрать для редакции systemd-системы;
- Блок `systemv-packages` - все пакеты (в нужном порядке), которые нужно собрать для редакции systemVInit-системы.

## Время сборки системы

Так как сборка любого дистрибутива занимает большое время, то даже такая небольшая система, как Calmira будет собираться долгое время.

Система собирается за 4 часа на следующей конфигурации:

- Intel Core i3-2370M
- 8 Гб ОЗУ DDR3
- 128 Гб SSD

За 7 часов на следующей конфигурации:

- Intel Celeron T3100
- 2 Гб ОЗУ DDR2
- 1 Тб HDD

> Собиралась systemVInit-редакция системы.

Время сборки может различасться в зависимости от хост-системы, версии GCC, установленного на хост-системе, конфигурации ПК, возможных ошибок и предупреждений во время сборки (некоторые из которых можно игнорировать), а так же многих других факторов.

## Замечания

- Для сборки данной системы нужно использовать помимо этого скрипта временный инструментарий ([версия LX4 1.0](https://github.com/CalmiraLinux/CalmiraLinux/releases/download/v1.0temp/calm-temp-sys_lx4.txz), [версия LX4 1.1](https://github.com/CalmiraLinux/CalmiraLinux/releases/download/v1.1temp/calm-temp-sys_lx4.1.1.tar.xz)). Требуется войти в chroot этого инструментария:

```bash
# Распакуйте нужный архив в /mnt/lin и выполните:
export CALM="/mnt/lin" # Замените /mnt/lin на ту директорию, в которую
                       # распаковали временный инструментарий

# Создание необходимых файлов
mknod -m 600 $CALM/dev/console c 5 1
mknod -m 666 $CALM/dev/null c 1 3

# Монтирование необходимых разделов
mount -v --bind /dev $CALM/dev
mount -v --bind /dev/pts $CALM/dev/pts
mount -vt proc proc $CALM/proc
mount -vt sysfs sysfs $CALM/sys
mount -vt tmpfs tmpfs $CALM/run

if [ -h $CALM/dev/shm ]; then
  mkdir -pv $CALM/$(readlink $CALM/dev/shm)
fi

# Вход в chroot
chroot "$CALM" /usr/bin/env -i           \
    HOME=/root TERM="$TERM"              \
    PS1='(system building) \u:\w\$ '     \
    PATH=/usr/bin                        \
    /bin/bash --login
```

После того, как система собрана, установлен загрузчик и произведены другие операции по настройке, выйдите из chroot:

```bash
# Выход
exit

# Размонтирование разделов
umount $CALM/dev{/pts,}
umount $CALM/{sys,proc,run}
```

* Для сборки необходимо скачать архивы с исходным кодом ПО нужных версий. Всё нужное для сборки предоставляется после выхода определённого релиза. Либо, если вы не хотите ждать выхода новой версии дистрибутива, а собрать nightly-билд, то в скором времени будет создан репозиторий с нужными архивами исходного кода нужного ПО, дождитесь.<br>Все архивы нужно поместить в `/usr/src`.